#########
# Cache #
#########

# Optimized for i5-9300H + 16GB RAM
cache=yes
cache-secs=900  # Reduced from 1800 for SVP efficiency
demuxer-max-back-bytes=75MiB  # Increased for better seeking
demuxer-max-bytes=150MiB  # Increased for SVP buffering
gpu-shader-cache-dir=~~/shaders/shader-cache-dir/
icc-cache-dir=~~/icc/icc-cache-dir/
stream-buffer-size=8MiB  # Increased for smoother streaming

########
# #subs #
########

sid=auto
slang=en,eng,english,english SDH,en SDH,eng SDH,ro,rou,romanian
sub-auto=fuzzy # Automatically load external subtitles with similar names
blend-subtitles=no	# Render subtitles on black bars when available
sub-ass-scale-with-window=no	# Make subtitle size relative to video resolution, not window size
sub-font="~~/fonts/NataSans-Regular.ttf"
sub-border-size=0.1
sub-outline-color=0.0/0.0/0.0/0.0  # fully transparent
sub-shadow-offset=2.0     # Small subtle drop shadow
sub-shadow-color=0.0/0.0/0.0/0.75 # Semi-transparent black shadow
sub-blur=0.3             
sub-align-x=center
sub-align-y=bottom
sub-file-paths-append=ass:srt:sub:subs:subtitles # Search for subtitles in these subdirectories (colon-separated)

#########
# Audio #
#########

alang=ja,jap,jpn,jp,eng,en,enUS,en-US
ao=wasapi
audio-exclusive=no
audio-format=float  # Better than s32 for modern systems
autosync=30
audio-file-auto=fuzzy
audio-pitch-correction=yes
volume-max=200

# Optimized audio filter chain
af=lavfi=[loudnorm=I=-16:TP=-3:LRA=4,acompressor=threshold=0.0625:ratio=2.5:attack=50:release=300:makeup=1,highpass=f=80,lowpass=f=16000]

###########
# GPU API #
###########

gpu-api=vulkan
vulkan-async-compute=yes
vulkan-async-transfer=yes
vulkan-queue-count=1  # Single queue for GTX 1650

##################
# Video Settings #
##################

profile=high-quality
vo=gpu-next
hwdec=auto-copy		# Enable hardware decoding for better SVP performance
hwdec-codecs=all

# Optimized for i5-9300H (4 cores/8 threads) + GTX 1650
vd-lavc-threads=0  # Let FFmpeg auto-detect (better than fixed 4)
vd-lavc-dr=yes
video-reversal-buffer=100000000  # Reduced for SVP efficiency
vd-queue-enable=yes
vd-queue-max-bytes=768MiB  # Reduced from 1536MiB for SVP
vd-queue-max-samples=30  # Reduced from 60
vd-queue-max-secs=60  # Reduced from 900

deband=no
deinterlace=auto

# Enhanced scaling for Anime4K compatibility
scale=ewa_lanczos
scale-radius=3.2239449
scale-blur=0.981251
dscale=mitchell
cscale=ewa_lanczos
correct-downscaling=yes  # Enable for better quality
linear-downscaling=no

# Dither optimized for gpu-next
dither=fruit
dither-depth=auto
temporal-dither=yes  # Better with Anime4K
temporal-dither-period=1

# Antiring
cscale-antiring=0.7
dscale-antiring=0.7
scale-antiring=0.7

# Colors - Universal compatibility
icc-profile-auto=no
icc-3dlut-size=64x64x64
target-prim=auto  # Auto-detect instead of forcing bt.2020
target-trc=auto   # Auto-detect instead of forcing PQ
gamma=0
target-colorspace-hint=yes
video-output-levels=auto

# OSD
osd-font=JetBrains Mono
osd-font-size=30
osd-border-size=1
osd-blur=0.5
osd-align-x=center
osd-bar=no
osd-margin-y=50
osd-duration=3000
script-opts=console-font_size=10

# Playback optimizations
force-seekable=yes
hr-seek-framedrop=no
#video-sync=display-resample  # Better frame timing
interpolation=no  # Disabled since we use SVP

# Performance optimizations for SVP
opengl-pbo=yes  # Better GPU memory handling
gpu-shader-cache-dir=~~/shaders/cache
watch-later-directory=~~/watch_later

##### AutoProfiles #####

[anime]
profile-cond=((get("video-params/h", -math.huge) > 720) and ((get("current-tracks/audio/lang", "") == 'ja') or (get("current-tracks/audio/lang", "") == 'jp') or (get("current-tracks/audio/lang", "") == 'jpn') or (get("current-tracks/audio/lang", "") == 'jap') or (get("current-tracks/audio/lang", "") == 'zh') or (get("current-tracks/audio/lang", "") == 'zho') or (get("current-tracks/audio/lang", "") == 'chi') or (get("current-tracks/audio/lang", "") == 'cmn') or (get("current-tracks/audio/lang", "") == 'yue') or (get("current-tracks/audio/lang", "") == 'ko') or (get("current-tracks/audio/lang", "") == 'kor')))

profile-restore=copy

osd-playing-msg=[Anime]: ${media-title}

alang=ja
slang=en

glsl-shaders-clr
vf-clr

# Anime4k: Optimized for 4K Displays on Low-End Specs
glsl-shaders="~~/shaders/Anime4K_Clamp_Highlights.glsl;~~/shaders/Anime4K_Restore_CNN_M.glsl;~~/shaders/Anime4K_Upscale_CNN_x2_M.glsl;~~/shaders/Anime4K_Upscale_Denoise_CNN_x2_M.glsl;~~/shaders/Anime4K_AutoDownscalePre_x2.glsl;~~/shaders/Anime4K_Thin_Fast.glsl;~~/shaders/Anime4K_Thin_VeryFast.glsl"

# SVP Frame Rate Conversion Optimized for 48 FPS
vf=@SVP:vapoursynth="~~/svp_main.vpy":buffered-frames=6:concurrent-frames=6

# Anime-specific optimizations
target-peak=100  # Better for anime HDR
brightness=2
contrast=5
saturation=5

# Debanding optimized for anime content
deband=yes
deband-iterations=1  # Lower for anime
deband-threshold=48  # Higher for anime
deband-range=20  # Increased for better coverage
deband-grain=16  # Increased for natural look

[legacy]
profile-cond=((get("video-params/h", -math.huge)<=720) and ((get("current-tracks/audio/lang", "") == 'ja') or (get("current-tracks/audio/lang", "") == 'jp') or (get("current-tracks/audio/lang", "") == 'jpn') or (get("current-tracks/audio/lang", "") == 'jap') or (get("current-tracks/audio/lang", "") == 'zh') or (get("current-tracks/audio/lang", "") == 'zho') or (get("current-tracks/audio/lang", "") == 'chi') or (get("current-tracks/audio/lang", "") == 'cmn') or (get("current-tracks/audio/lang", "") == 'yue') or (get("current-tracks/audio/lang", "") == 'ko') or (get("current-tracks/audio/lang", "") == 'kor')))

profile-restore=copy

osd-playing-msg=[Legacy][Anime]: ${media-title}

alang=ja
slang=en

glsl-shaders-clr
vf-clr

# Anime4k: Optimized for 4K Displays on Low-End Specs
glsl-shaders="~~/shaders/Anime4K_Clamp_Highlights.glsl;~~/shaders/Anime4K_Restore_CNN_M.glsl;~~/shaders/Anime4K_Upscale_CNN_x2_M.glsl;~~/shaders/Anime4K_Upscale_Denoise_CNN_x2_M.glsl;~~/shaders/Anime4K_AutoDownscalePre_x2.glsl;~~/shaders/Anime4K_Thin_Fast.glsl;~~/shaders/Anime4K_Thin_VeryFast.glsl"

# 1) DEINTERLACE (PAL/NTSC true interlaced)
#   mode=1  -> spatial+temporal
#   parity=auto -> detects TFF/BFF
#   deint=all -> deinterlace all frames even if flags are wrong
vf=lavfi=[bwdif=mode=1:parity=auto:deint=all]

# SVP Frame Rate Conversion Optimized for 48 FPS
vf-add=@SVP:vapoursynth="~~/svp_main.vpy":buffered-frames=6:concurrent-frames=6

# Legacy-optimized settings
deband=no
scale=bilinear  # Simple scaling for old content
dscale=bilinear
brightness=2
contrast=5
saturation=5

[general]
profile-cond=(get("video-params/h", -math.huge)>719 and get("video-params/h", -math.huge)<2159)
 
osd-playing-msg=[ðŸŽ¬]: ${media-title}

profile-restore=copy

# Clear existing shaders and filters
glsl-shaders-clr
vf-clr

# General content shader chain (lighter than Anime4K)
glsl-shaders="~~/shaders/hdeband.glsl"

[4k]
profile-cond=(get("video-params/w", -math.huge)>=3840)

osd-playing-msg=[4K][ðŸŽ¬]: ${media-title}

# 4K specific optimizations
glsl-shaders-clr
vf-clr
deband=no  # Disable for 4K performance
target-colorspace-hint=yes
hwdec=auto  # Force hardware decode for 4K